{{ template "header" . }}
{{ template "head_menu" . }}
<br/><br/>
<div class="page_content">
{{ if eq .first_time_login "yes" }}
<h2>Welcome to webnote.</h2>

<p>This is your first time login. So you have to change your default password and then set up your OTP QR images.</p>

<p>You need to install an OTP application on your phone. For android/iphone search for Google Authenticator</p>

<p>After installing click this <a target="_blank" href="/edituser">link</a> to enter the account management page. From there, type current password in 
   `Current or Admin Password`, Type new password in `New Password`. Note that you can not change the email admin@admin.com. If you want your custom email, 
   use the functionality to add a new user rather.

   Then click button `Add/Edit User` to edit current user.

   Now logout and re-login using the changed password. 

   Once logged in go back to user management link, type your admin password and click the button `Generate new OTP QR image`. Then use the authenticator 
   app to scan and add it in</p>  

   Your HAVE to enable OTP after the second login otherwise your admin account will be locked. You need to run the cli to handle these cases. Run the cli with 
   option -h to print out the capabilities.
   
   For normal usage better to create non admin account.

  You can add more users using the same user management page.

<p>The next time to login you are required to enter the OTP code generated by the authenticator application in the login page (the last input)</p>

{{ end }}
</div>
<form method="POST" action="{{ .settings.BASE_URL }}/savenote" name="note" class="page_content" id="note">{{ .csrfField }}
<input type="hidden" name="id" value="{{ .note.ID }}"/>
<table class="note-table">
    <tr>
        <TD><i>Title</i></TD>
        <td colspan="3"><input type="text" name="title" value="{{ .note.Title }}" size="65"/></td>
    </tr>
    <tr>
        <TD><i>Datelog</i></TD>
        <td><input type="text" name="datelog" value='{{ .note.Datelog | time_fmt .date_layout }}' size="25"/></td>
        <td><i>Tags :A:B:C</i></td>
        <td><input type="text" name="flags" value="{{ .note.Flags }}" size="25"/></td>
    </tr>
<!-- <tr><TD>&nbsp;</TD><td colspan="2"><textareA class='ckeditor' id="content" name="content" -->
    <tr>
        <TD>&nbsp;</TD>
        <td colspan="3"><textarea id="content" name="content" wrap="soft" autocomplete="on"
cols="150" rows="25">{{ .note.Content }}</textarea></td>
    </tr>
{{ if eq .note.RawEditor 1 }}
<!-- No HTML editor Handle TAB key -->
<script language="javascript">
var textareas = document.getElementsByName('content');
var count = textareas.length;
for(var i=0;i<count;i++){
    textareas[i].onkeydown = function(e){
        if(e.keyCode==9 || e.which==9){
            e.preventDefault();
            var s = this.selectionStart;
            this.value = this.value.substring(0,this.selectionStart) + "\t" + this.value.substring(this.selectionEnd);
            this.selectionEnd = s + 1;
        }
    }
}
</script>
{{ else }}
<script>CKEDITOR.replace( 'content', {
    allowedContent: true,
    dataIndentationChars: '  ',
    tabSpaces: 2,
    fullPage: true,
    extraPlugins: 'imagepaste'
});
</script>
{{ end }}
<script>
    var typingTimer;                //timer identifier
    var doneTypingInterval = 5000;  //time in ms (5 seconds)
    var myInput = document.getElementById('note');

    function save_note() {
        // if (! isFormChanged) { return }
        if (CKEDITOR.instances['content']) {
            CKEDITOR.instances['content'].updateElement();
        }
        note_content = document.getElementsByName('content')[0].value;
        if (note_content == '') { return }
        var request = new XMLHttpRequest();
        request.open(myInput.method, myInput.action);
        request.send(new FormData(myInput));
    }
    function do_after_onchange() {
        clearTimeout(typingTimer);
        typingTimer = setTimeout(save_note, doneTypingInterval);
    }
    if (CKEDITOR.instances['content']) {
        // console.log("Need to use ckeditor to detect change event");
        var content_editor = CKEDITOR.instances['content'];
        //ckeditor keyup does not work, input not work as well
        content_editor.on( 'key', do_after_onchange);
    } else {
        myInput.addEventListener("input", do_after_onchange);
    }
</script>
    <tr>
        <TD><i>Url</i></TD>
        <td colspan="2"><input type="text" name="url" value="{{ .note.URL }}" size="55" /> </td>
        <td>raw editor<input type="checkbox" {{ if eq .note.RawEditor 1 }}checked="checked"{{ end }} value="1" name="raw_editor"></td>
    </tr>
    <tr>
        <TD>
            {{ if or (eq .note.AuthorID .user.ID) (eq .note.AuthorID 0) }}
                {{ $ngroup := "" }}
                <select name="ngroup">
                {{ if .note.Group }}
                    {{ $ngroup = .note.Group.Name }}
                {{ else }}
                    {{ $ngroup = "default" }}
                {{ end }}
                {{ range $idx, $gr := .groups }}
                    <option value="{{ $gr.Name }}" {{ if eq $ngroup $gr.Name }} selected="selected" {{ end }}>{{ $gr.Name }}</option>
                {{ end }}
                </select>
            {{ else }}
                {{ if .note.Group }}
                <input type="hidden" name="ngroup" value="{{ .note.Group.Name }}">
                {{ end }}
            {{ end }}
        </td>
        <td>
            {{ if or (eq .note.AuthorID .user.ID) (eq .note.AuthorID 0) }}
                <select name="permission">
                {{ $note := .note }}
                {{ range $permVal, $perm := .permission_list }}
                <option value="{{ $permVal }}" {{ if eq $permVal $note.Permission }} selected="selected" {{ end }}>{{ $perm }}</option>
                {{ end }}
                </select>
            {{ else }}
                <input type="hidden" name="permission" value="{{.note.Permission}}" >
            {{ end }}
<!-- Reminder <input type="checkbox" name="reminder" {% if note.reminder_ticks and note.reminder_ticks|is_gt:0 %} checked="true" {% endif %} value=""/> -->
        </td>
        <td align="center" colspan="2">
            <!-- <input type="submit" name="sendmail" value="Email note"/> -->
            <input type="button" name="savenote" value="Save" onclick="save_note();"/>
        </td>
    </tr>
</table>
</form><br>
{{ template "list_note_attachment" . }}
<br><br>
{{ template "footer" . }}
</body>
</html>